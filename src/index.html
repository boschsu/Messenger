<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<title>Messenger - NII</title>

	<style type="text/css">
		* { font-family:tahoma; font-size:12px; padding:0px; margin:0px; }
        p { line-height:18px; }
        div { width:500px; margin-left:auto; margin-right:auto;}
        #conversation_board { padding:5px; background:#ddd; border-radius:5px; overflow-y: scroll;
                   border:1px solid #CCC; margin-top:10px; height: 160px; }
        .input_text { border-radius:2px; border:1px solid #ccc;
                 margin-top:10px; padding:5px; width:400px;  }
        #status { width:88px; display:block; float:left; margin-top:15px; }
	</style>

    <script src="https://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios@0.18.0/dist/axios.js"></script>

</head>

<body>

<form action="postlogin" method="post" id="postlogin" enctype=>
    <label>Name: <input class="input_text" type="text" name="name" placeholder="Type your name here" /></label><br />
    <label>Age: <input class="input_text" type="text" name="age" placeholder="Type your age here" /></label>
    <input type="submit" value="Done" />
</form>

<span id="status">Connecting...</span>
<input class="input_text" id="input_messenger" type="text" disabled="disabled" />
<button id="send_messenger">发送</button>

<div id="conversation_board"></div>

<script type="text/javascript">
$(function () {
    "use strict";

    var url='ws://127.0.0.1:3001';

    $.fn.serializeObject = function(){
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };

    // for better performance - to avoid searching in DOM
    var content = $('#conversation_board');
    var input = $('#input_messenger');
    var send = $('#send_messenger');
    var status = $('#status');
    var postlogin=$('#postlogin');
    
    postlogin.on('submit',function(e){
        e.preventDefault();
        var xhr=new XMLHttpRequest();
        xhr.open('post', 'postlogin', true);
        xhr.onreadystatechange=function(){
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log(xhr.responseText)
                var result=JSON.parse(xhr.responseText);
                afterAuth(result.name);
            }
        }
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");//declare this is a form
        xhr.send($('#postlogin').serialize());  
    })

    function afterAuth(name){
        sendMessenger(name);
    }

    // my color assigned by the server
    var myColor = false;
    // my name sent to the server
    var myName = false;

    // if user is running mozilla then use it's built-in WebSocket
    window.WebSocket = window.WebSocket || window.MozWebSocket;

    // if browser doesn't support WebSocket, just show some notification and exit
    if (!window.WebSocket) {
        content.html($('<p>', { text: 'Sorry, but your browser doesn\'t '
                                    + 'support WebSockets.'} ));
        input.hide();
        status.hide();
        button.hide();
        return;
    }

    // open connection
    var connection = new WebSocket(url);

    connection.onopen = function () {
        // first we want users to enter their names
        input.removeAttr('disabled');
        status.text('Choose name:');
    };

    connection.onerror = function (error) {
        // just in there were some problems with conenction...
        content.html($('<p>', { text: 'Sorry, but there\'s some problem with your '
                                    + 'connection or the server is down.' } ));
    };

    // most important part - incoming messages
    connection.onmessage = function (message) {
        // try to parse JSON message. Because we know that the server always returns
        // JSON this should work without any problem but we should make sure that
        // the massage is not chunked or otherwise damaged.
        try {
            var json = JSON.parse(message.data);
        } catch (e) {
            console.log('This doesn\'t look like a valid JSON: ', message.data);
            return;
        }

        // NOTE: if you're not sure about the JSON structure
        // check the server source code above
        if (json.type === 'color') { // first response from the server with user's color
            myColor = json.data;
            status.text(myName + ': ').css('color', myColor);
            input.removeAttr('disabled').focus();
            // from now user can start sending messages
        } else if (json.type === 'history') { // entire message history
            // insert every single message to the chat window
            for (var i=0; i < json.data.length; i++) {
                addMessage(json.data[i].author, json.data[i].text,
                           json.data[i].color, new Date(json.data[i].time));
            }
        } else if (json.type === 'message') { // it's a single message
            input.removeAttr('disabled'); // let the user write another message
            addMessage(json.data.author, json.data.text,
                       json.data.color, new Date(json.data.time));
        } else {
            console.log('Hmm..., I\'ve never seen JSON like this: ', json);
        }
    };

    /**
     * Send mesage when user presses Enter key
     */
    send.on('click',function(e) {
        //if (e.keyCode === 13) {
            sendMessenger()
        //}
    });
    input.on('keyup',function(e) {
        if (e.keyCode === 13) {
            sendMessenger()
        }
    });

    function sendMessenger(msg){
        var msg = msg|| input.val();
        if (!msg) {
            return;
        }
        // send the message as an ordinary text
        connection.send(msg);
        input.val('');
        // disable the input field to make the user wait until server
        // sends back response
        input.attr('disabled', 'disabled');

        // we know that the first message sent from a user their name
        if (myName === false) {
            myName = msg;
        }
    }

    /**
     * This method is optional. If the server wasn't able to respond to the
     * in 3 seconds then show some error message to notify the user that
     * something is wrong.
     */
    setInterval(function() {
        if (connection.readyState !== 1) {
            status.text('Error');
            input.attr('disabled', 'disabled').val('Unable to comminucate '
                                                 + 'with the WebSocket server.');
        }
    }, 3000);

    /**
     * Add message to the chat window
     */
    function addMessage(author, message, color, timestamp) {
        content.prepend(
            '<p><span style="color:' 
            + color 
            + '">' 
            + author 
            + '</span> @ ' 
            + new Date(timestamp).toLocaleString()
            + ': ' 
            + message 
            + '</p>'
        );
    }
});
</script>
</body>
</html>